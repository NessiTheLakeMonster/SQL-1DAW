-- ACTIVIDAD 7

DROP TABLE PED_PROD;
DROP TABLE PEDIDO;
DROP TABLE PRODUCTO;
DROP TABLE CATEGORIA;
DROP TABLE REPARTIDOR;
DROP TABLE CLIENTE;
DROP TABLE ZONA;

--Las zonas de reparto son
CREATE TABLE ZONA(
    COD NUMBER(3) PRIMARY KEY,
    NOMBRE VARCHAR2(30)
);
INSERT INTO ZONA VALUES(1,'NORTE');
INSERT INTO ZONA VALUES(2,'SUR');
INSERT INTO ZONA VALUES(3, 'CENTRO');
--CLIENTES DE MI SUPERMERCADO ONLINE
CREATE TABLE CLIENTE(
    DNI VARCHAR2(12) PRIMARY KEY,
    NOMBRE VARCHAR2(30),
    PROFESION VARCHAR2(30),
    TFNO NUMBER(11),
    DIRECCION VARCHAR2(60),
    COD_ZONA NUMBER(3),
    FOREIGN KEY (COD_ZONA) REFERENCES ZONA(COD)
);
INSERT INTO CLIENTE VALUES('05912345N', 'ANTONIO', 'CONDUCTOR', 67565723, 'C/SOLEDAD 27 PUERTOLLANO', 1);
INSERT INTO CLIENTE VALUES('05942445S', 'Ana', 'ENFERMERA', 65565723, 'C/OLIVO 2 3?A PUERTOLLANO', 2);
INSERT INTO CLIENTE VALUES('05913425T', 'ANA', 'ENFERMERA', 68888723, 'C/APRISCO 44 2?B PUERTOLLANO', 1);
INSERT INTO CLIENTE VALUES('70913425W', 'FEDERICO', 'PROFESOR', 65555723, 'C/OLIVO 12 5?A PUERTOLLANO', 1);
INSERT INTO CLIENTE VALUES('03333333S', 'PEPE', 'ENFERMERA', 68888723, 'C/APRISCO 78 2?B PUERTOLLANO', 2);
INSERT INTO CLIENTE VALUES('05753254T', 'ana', 'PROFESORA', 67322723, 'C/GOYA 56 5?B PUERTOLLANO', 1);
INSERT INTO CLIENTE VALUES('02333235J', 'LUISA', 'ENFERMERA', 68888756, 'C/GOYA 56 2?B PUERTOLLANO', 2);
INSERT INTO CLIENTE VALUES('05334259T', 'PEDRO', 'ENFERMERO', 66544723, 'C/APRISCO 56 6?B ARGAMASILLA CVA', 3);
INSERT INTO CLIENTE VALUES('05900025K', 'JOSEFA', 'CONDUCTORA', 69999977, 'C/OURENSE 3 6?C PUERTOLLANO', 3);
INSERT INTO CLIENTE VALUES('05313525D', 'ANA', 'CONDUCTORA', 68845723, 'C/LARGA 45 1?B ARGAMASILLA CVA', 3);
--TABLA DE REPARTIDORES
CREATE TABLE REPARTIDOR(
    MATRICULA VARCHAR2(10) PRIMARY KEY,
    NOMBRE VARCHAR2(30),
    COD_ZONA NUMBER(3),
    FOREIGN KEY (COD_ZONA) REFERENCES ZONA(COD) 
);
INSERT INTO REPARTIDOR VALUES('1212BBR', '?NGELA', 1);
INSERT INTO REPARTIDOR VALUES('4532SSI', 'Sandra', 1);
INSERT INTO REPARTIDOR VALUES('5655TDD', 'ANA', 2);
INSERT INTO REPARTIDOR VALUES('8766VBV', 'ANTONIO', 3);
INSERT INTO REPARTIDOR VALUES('4444GGG', 'SOF?A', 3);
INSERT INTO REPARTIDOR VALUES('6555FFF', 'RUB?N', 3);

--PEDIDO QUE HACE UN CLIENTE Y REPARTE UN REPARTIDOR
CREATE TABLE PEDIDO(
    COD NUMBER(8) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    FECHA DATE NOT NULL,
    COD_CLIENTE VARCHAR2(12),
    COD_REPARTIDOR VARCHAR2(10),
    FOREIGN KEY (COD_CLIENTE) REFERENCES CLIENTE(DNI),
    FOREIGN KEY (COD_REPARTIDOR) REFERENCES REPARTIDOR(MATRICULA)
);
INSERT INTO PEDIDO(FECHA, COD_CLIENTE, COD_REPARTIDOR)
VALUES (TO_DATE('23/12/2022', 'DD/MM/YYYY'), '05912345N', '1212BBR');
INSERT INTO PEDIDO(FECHA, COD_CLIENTE, COD_REPARTIDOR)
VALUES (TO_DATE('23/12/2022', 'DD/MM/YYYY'), '05942445S', '4532SSI');
INSERT INTO PEDIDO(FECHA, COD_CLIENTE, COD_REPARTIDOR)
VALUES (TO_DATE('23/12/2022', 'DD/MM/YYYY'), '05912345N', '4532SSI');
INSERT INTO PEDIDO(FECHA, COD_CLIENTE, COD_REPARTIDOR)
VALUES (TO_DATE('23/12/2022', 'DD/MM/YYYY'), '05913425T', '4532SSI'); 
INSERT INTO PEDIDO(FECHA, COD_CLIENTE, COD_REPARTIDOR)
VALUES (TO_DATE('10/02/2022', 'DD/MM/YYYY'), '02333235J', '8766VBV'); 
INSERT INTO PEDIDO(FECHA, COD_CLIENTE, COD_REPARTIDOR)
VALUES (TO_DATE('12/08/2022', 'DD/MM/YYYY'), '02333235J', '8766VBV'); 
INSERT INTO PEDIDO(FECHA, COD_CLIENTE, COD_REPARTIDOR)
VALUES (TO_DATE('23/10/2022', 'DD/MM/YYYY'), '02333235J', '8766VBV'); 
INSERT INTO PEDIDO(FECHA, COD_CLIENTE, COD_REPARTIDOR)
VALUES (TO_DATE('25/09/2022', 'DD/MM/YYYY'), '02333235J', '6555FFF'); 

--Las categorias de los productos
CREATE TABLE CATEGORIA(
    COD_CATEGORIA VARCHAR2(10) PRIMARY KEY,
    NOMBRE VARCHAR2(30));
INSERT INTO CATEGORIA VALUES('PER', 'PERFUME');
INSERT INTO CATEGORIA VALUES('DUL', 'DULCE');
INSERT INTO CATEGORIA VALUES('REF', 'REFRESCO');

--PRODUCTOS QUE HAY EN EL SUPERMERCADO
CREATE TABLE PRODUCTO(
    COD NUMBER(8) GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(30),
    MARCA VARCHAR2(30),
    ORIGEN VARCHAR2(30),
    VOLUMEN NUMBER(7,2),
    PESO NUMBER(7,2),
    CATEGORIA VARCHAR2(10),
    FOREIGN KEY (CATEGORIA) REFERENCES CATEGORIA(COD_CATEGORIA));
INSERT INTO PRODUCTO(NOMBRE, MARCA, ORIGEN, VOLUMEN, PESO, CATEGORIA)
VALUES ('CHAMP?', 'MARCA1', 'ESPA?A', '50', '1', 'PER');
INSERT INTO PRODUCTO(NOMBRE, MARCA, ORIGEN, VOLUMEN, PESO, CATEGORIA)
VALUES ('PERFUME', 'MARCA1', 'ESPA?A', '50', '3', 'PER');
INSERT INTO PRODUCTO(NOMBRE, MARCA, ORIGEN, VOLUMEN, PESO, CATEGORIA)
VALUES ('GEL', 'MARCA2', 'FRANCIA', '40', '2', 'PER');
INSERT INTO PRODUCTO(NOMBRE, MARCA, ORIGEN, VOLUMEN, PESO, CATEGORIA)
VALUES ('GALLETAS', 'MARCA1', 'ESPA?A', '30', '2', 'DUL');
INSERT INTO PRODUCTO(NOMBRE, MARCA, ORIGEN, VOLUMEN, PESO, CATEGORIA)
VALUES ('CHOCOLATE', 'MARCA2', 'FRANCIA', '5', '0.5', 'DUL');
INSERT INTO PRODUCTO(NOMBRE, MARCA, ORIGEN, VOLUMEN, PESO, CATEGORIA)
VALUES ('COCA COLA', 'MARCA1', 'ESPA?A', '2', '4', 'REF');
INSERT INTO PRODUCTO(NOMBRE, MARCA, ORIGEN, VOLUMEN, PESO, CATEGORIA)
VALUES ('FANTA', 'MARCA1', 'ESPA?A', '5', '1', 'REF');
INSERT INTO PRODUCTO(NOMBRE, MARCA, ORIGEN, VOLUMEN, PESO, CATEGORIA)
VALUES ('LECHE', 'MARCA1', 'ESPA?A', '3', '3', 'REF');
--TABLA PEDIDO-PRODUCTO
CREATE TABLE PED_PROD(
    COD_PEDIDO NUMBER(8),
    COD_PRODUCTO NUMBER(8),
    CANTIDAD NUMBER(8),
    PRIMARY KEY (COD_PEDIDO, COD_PRODUCTO),
    FOREIGN KEY (COD_PEDIDO) REFERENCES PEDIDO(COD),
    FOREIGN KEY (COD_PRODUCTO) REFERENCES PRODUCTO(COD));
INSERT INTO PED_PROD VALUES(1,1,2);
INSERT INTO PED_PROD VALUES(1,2,1);
INSERT INTO PED_PROD VALUES(1,3,3);
INSERT INTO PED_PROD VALUES(1,4,1);
INSERT INTO PED_PROD VALUES(2,1,1);
INSERT INTO PED_PROD VALUES(2,3,1);
INSERT INTO PED_PROD VALUES(2,7,5);
INSERT INTO PED_PROD VALUES(2,8,4);
INSERT INTO PED_PROD VALUES(3,1,2);
INSERT INTO PED_PROD VALUES(4,8,1);
INSERT INTO PED_PROD VALUES(4,2,6);

----------------------------------------------------------------------------------------
--? 1. Saca el nombre de las categorías que hay en el supermercado junto con el total de 
--     productos que hay en cada categoría.
SELECT CATEGORIA.NOMBRE, COUNT(*)AS TOTAL_PRODUCTOS
FROM PRODUCTO JOIN CATEGORIA
ON CATEGORIA.COD_CATEGORIA = PRODUCTO.CATEGORIA
GROUP BY CATEGORIA.NOMBRE;
    
--? 2. Saca el número total de clientes que hay en cada zona de reparto junto al nombre de la zona.
SELECT ZONA.NOMBRE, COUNT(*) AS TOTAL_CLIENTES
FROM ZONA JOIN CLIENTE
ON ZONA.COD = CLIENTE.COD_ZONA
GROUP BY ZONA.NOMBRE;
    
--? 3. Saca el número total de clientes que hay en cada zona de reparto junto al nombre 
--     de la zona solo de aquellas zonas que tengan menos de 4 clientes.
SELECT ZONA.NOMBRE, COUNT(*) AS TOTAL_CLIENTES
FROM ZONA JOIN CLIENTE
ON ZONA.COD = CLIENTE.COD_ZONA
GROUP BY ZONA.NOMBRE
    HAVING COUNT(*) < 4;

--? 4. Saca un listado con el nombre de los repartidores junto al nombre de su zona de 
--     reparto ordenado por zona de reparto y luego por nombre de repartidor.
SELECT REPARTIDOR.NOMBRE, ZONA.NOMBRE
FROM REPARTIDOR JOIN ZONA
ON REPARTIDOR.COD_ZONA = ZONA.COD
ORDER BY ZONA.NOMBRE; -- ordenado por zona de reparto

SELECT REPARTIDOR.NOMBRE, ZONA.NOMBRE
FROM REPARTIDOR JOIN ZONA
ON REPARTIDOR.COD_ZONA = ZONA.COD
ORDER BY REPARTIDOR.NOMBRE; -- ordenado por nombre de repartidor
    
--? 5. Saca un listado ordenado por nombre de zona y el número total de repartidores que tiene.
SELECT ZONA.NOMBRE, COUNT(*) AS TOTAL_REPARTIDORES
FROM ZONA JOIN REPARTIDOR
ON ZONA.COD = REPARTIDOR.COD_ZONA
GROUP BY ZONA.NOMBRE;

--? 6. Saca el número de repartidores que tiene la zona ‘norte’.
SELECT ZONA.NOMBRE, COUNT(*) AS TOTAL_REPARTIDORES
FROM ZONA JOIN REPARTIDOR
ON ZONA.COD = REPARTIDOR.COD_ZONA
GROUP BY ZONA.NOMBRE
    HAVING UPPER(ZONA.NOMBRE) LIKE 'NORTE';
    
--? 7. Saca el nombre de todos los clientes a los que les han repartido repartidores de la zona ‘norte’. 
--     (Cuidado con lo que se llamen igual, no tienen porque ser la misma persona, usa DISTINCT si es necesario) . 
--     Ordena por NOMBRE de cliente.
    
--? 8. Saca el número de veces que a un cliente le han repartido repartidores de la zona ‘norte’ 
--     junto con el nombre del cliente.
    
--? 9. Saca el total del peso de cada pedido ordenado por fechas.